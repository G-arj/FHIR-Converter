{% mergeDiff msg -%}
{
  "encounter" : {{msg.context | to_json_string}},
  "related" : "",
  "note" : [
    {% include 'Shared/String2Annotation' msg: msg.comment -%}
  ],
  "comment" : "",
  {% for r in msg.related %}
  {% case r.type %}
    {% when "has-member" %}
      "hasMember" : {{r.target | to_json_string }},
    {% when "derived-from" %}
      "derivedFrom" : {{r.target | to_json_string }},
  {% endcase %}
  {% endfor %}

  "extension":[
    {% for r in msg.related %}
    {% case r.type %}
      {% when "sequel-to" %}
        {
            "url":"http://hl7.org/fhir/3.0/StructureDefinition/Observation.sequelTo",
            "valueReference": {{r.target | to_json_string }}
        },
      {% when "replaces" %}
        {
            "url":"http://hl7.org/fhir/3.0/StructureDefinition/Observation.replaces",
            "valueReference": {{r.target | to_json_string }}
        },
      {% when "qualified-by" %}
        {
            "url":"http://hl7.org/fhir/3.0/StructureDefinition/Observation.qualifiedBy",
            "valueReference": {{r.target | to_json_string }}
        },
      {% when "interfered-by" %}
        {
            "url":"http://hl7.org/fhir/3.0/StructureDefinition/Observation.interferedBy",
            "valueReference": {{r.target | to_json_string }}
        },
    {% endcase %}
  {% endfor %}
  ],
  "context" : ""
}
{% endmergeDiff -%}

